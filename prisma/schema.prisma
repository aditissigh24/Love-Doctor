generator client {
  provider   = "prisma-client-js"
  output     = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/* -------------------- USERS -------------------- */

model User {
  id          String    @id @default(cuid())
  phone       String?   @unique
  email       String?   @unique
  countryCode String    @default("+91")
  
  // Profile (static or rarely changing)
  name        String?
  ageRange    String?   // ✅ "18-24", "25-34" - doesn't need updates
  gender      Gender?
  
  // External Platform IDs
  otplessUserId      String?
  likeMindsUserId    String?   @unique
  likeMindsMemberId  Int?      @unique
  
  // User Situations
  situations         String[]  // Array of past situations
  currentSituation   String?   @db.Text
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?
  deletedAt   DateTime? // ✅ Soft delete
  
  // Relations
  conversations    Conversation[]
  
  @@index([phone])
  @@index([email])
  @@index([deletedAt]) // ✅ For filtering deleted users
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY      // ✅ Better than "OTHER"
  PREFER_NOT_SAY  // ✅ Privacy option
}

/* -------------------- COACHES -------------------- */

model Coach {
  id        Int      @id @default(autoincrement())
  name      String
  title     String
  specialty String
  bio       String?  @db.Text
  imageUrl  String?
  tags      String[] // ✅ For categorization ["Attachment", "Dating"]

  // Authentication
  phone       String?   @unique
  email       String?   @unique
  countryCode String    @default("+91")
  lastLoginAt DateTime?
  
  // ✅ LikeMinds Integration
  likemindsUuid     String  @unique
  likemindsMemberId Int?    @unique
  
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // ✅ Soft delete
  
  conversations   Conversation[]
  
  @@index([isActive])
  @@index([deletedAt])
}

/* -------------------- CONVERSATIONS -------------------- */

model Conversation {
  id            String              @id @default(cuid())
  userId        String
  coachId       Int
  
  // LikeMinds Integration
  chatroomId    String              @unique
  
  status        ConversationStatus  @default(ACTIVE)
  
  // Timestamps
  startedAt     DateTime            @default(now())
  lastMessageAt DateTime            @default(now())
  endedAt       DateTime?
  deletedAt     DateTime?           // ✅ Soft delete
  
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  coach         Coach               @relation(fields: [coachId], references: [id])
  
  messages      Message[]
  
  @@index([userId, status])
  @@index([coachId, status])
  @@index([status])
  @@index([startedAt])        // ✅ For time-based queries
  @@index([lastMessageAt])    // ✅ For sorting by recent activity
  @@index([deletedAt])
}

enum ConversationStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

/* -------------------- MESSAGES -------------------- */
// ⚠️ This table will grow MASSIVE - consider partitioning by createdAt
model Message {
  id             String      @id @default(cuid())
  conversationId String
  
  senderType     SenderType
  senderId       String      // userId or coachId
  
  // ✅ Rich content support
  messageType    MessageType @default(TEXT)
  text           String?     @db.Text
  attachmentUrl  String?
  
  // ✅ LikeMinds Integration
  likemindsMessageId String?  @unique
  
  createdAt      DateTime    @default(now())
  deletedAt      DateTime?   // ✅ Soft delete for messages
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([createdAt])        // ✅ CRITICAL for time-series queries
  @@index([deletedAt])
  
  // ⚠️ Consider partitioning by createdAt for scale:
  // CREATE TABLE messages_2024_01 PARTITION OF messages FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
}

enum SenderType {
  USER
  COACH
  SYSTEM
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}